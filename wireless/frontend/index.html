<!DOCTYPE html>
<html>
<head>
    <title>Wireless Data Platform</title>
    <meta charset="UTF-8">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width:1200px; margin:0 auto; }

        /* Header */
        .header { background:white; padding:30px; border-radius:15px;
                  box-shadow:0 10px 30px rgba(0,0,0,.2); margin-bottom:30px; text-align:center; }
        .header h1 { color:#667eea; font-size:2.5em; margin-bottom:10px; }

        /* Stats */
        .stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
                 gap:20px; margin-bottom:30px; }
        .stat-card { background:white; padding:25px 15px; border-radius:15px;
                     box-shadow:0 5px 15px rgba(0,0,0,.1); text-align:center; }
        .stat-card .value { font-size:2.2em; font-weight:bold; color:#667eea; margin-bottom:5px; }
        .stat-card .label { color:#666; font-size:.85em; }

        /* ‚îÄ‚îÄ Jupyter Panel ‚îÄ‚îÄ */
        .jupyter-panel {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,.2);
            margin-bottom: 30px;
            overflow: hidden;
        }
        .jupyter-header {
            background: linear-gradient(135deg, #f97316, #ea580c);
            padding: 18px 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .jupyter-header h2 { color:white; font-size:1.3em; margin:0; }
        .jupyter-header .nb-status-badge {
            padding: 5px 14px; border-radius: 20px; font-size:.82em; font-weight:600;
        }
        .badge-stopped   { background:rgba(255,255,255,.2); color:white; }
        .badge-starting  { background:#fbbf24; color:#78350f; animation: pulse 1.4s infinite; }
        .badge-running   { background:#22c55e; color:white; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }

        .jupyter-body { padding:24px 28px; }

        /* button row */
        .nb-actions { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:18px; }

        /* open-notebook link */
        .open-notebook-link {
            display:none; /* shown only when running */
            background:#f97316; color:white; text-decoration:none;
            padding:11px 24px; border-radius:8px; font-weight:600; font-size:.95em;
            transition: background .2s;
        }
        .open-notebook-link:hover { background:#ea580c; }
        .open-notebook-link.show { display:inline-block; }

        /* drag zone inside jupyter panel */
        .nb-drop-zone {
            border: 2px dashed #f97316;
            border-radius: 10px;
            padding: 28px;
            text-align: center;
            transition: all .3s;
            background: #fff7ed;
        }
        .nb-drop-zone.drag-over { background:#ffedd5; border-color:#dc2626; }
        .nb-drop-zone p { color:#9a3412; font-size:.88em; margin:6px 0; }
        .nb-drop-zone .drop-icon { font-size:2em; }
        .nb-msg { margin-top:10px; min-height:24px; font-size:.85em; }

        /* Upload */
        .upload-section { background:white; padding:30px; border-radius:15px;
                          box-shadow:0 10px 30px rgba(0,0,0,.2); margin-bottom:30px; }
        .upload-area { border:3px dashed #667eea; border-radius:10px; padding:40px;
                       text-align:center; transition:all .3s; }
        .upload-area.drag-over { background:#e8f0ff; border-color:#4858c9; }
        .file-selected { background:#f0f9ff; padding:15px; border-radius:8px; margin:15px 0;
                         display:none; justify-content:space-between; align-items:center; }
        .file-selected.show { display:flex; }

        /* Buttons */
        .btn { padding:12px 28px; border:none; border-radius:8px; font-size:1em;
               cursor:pointer; font-weight:600; margin:4px; transition:all .2s; }
        .btn-primary   { background:#667eea; color:white; }
        .btn-primary:hover   { background:#5568d3; }
        .btn-success   { background:#10b981; color:white; }
        .btn-success:hover   { background:#059669; }
        .btn-secondary { background:#6b7280; color:white; }
        .btn-secondary:hover { background:#4b5563; }
        .btn-danger    { background:#ef4444; color:white; padding:8px 14px; font-size:.82em; }
        .btn-danger:hover    { background:#dc2626; }
        .btn-orange    { background:#f97316; color:white; }
        .btn-orange:hover    { background:#ea580c; }
        .btn-sm        { padding:8px 18px; font-size:.85em; }

        /* File list */
        .files-section { background:white; padding:30px; border-radius:15px;
                         box-shadow:0 10px 30px rgba(0,0,0,.2); }
        .files-section h2 { color:#333; margin-bottom:20px; }
        .file-list { display:grid; gap:12px; }
        .file-item { background:#f8f9fa; padding:18px 20px; border-radius:10px;
                     display:flex; justify-content:space-between; align-items:center; transition:all .2s; }
        .file-item:hover { transform:translateY(-2px); box-shadow:0 5px 15px rgba(0,0,0,.1); }
        .file-info { flex:1; }
        .file-name { font-weight:600; color:#333; margin-bottom:4px; }
        .file-meta { color:#666; font-size:.82em; }
        .file-actions { display:flex; gap:8px; align-items:center; }

        .file-type { padding:4px 14px; border-radius:20px; font-size:.8em; font-weight:600; }
        .type-channels   { background:#e3f2fd; color:#1976d2; }
        .type-timestamps { background:#f3e5f5; color:#7b1fa2; }
        .type-csv        { background:#e8f5e9; color:#2e7d32; }
        .type-mat        { background:#fff3e0; color:#e65100; }

        .analyze-btn { background:#10b981; color:white; padding:8px 14px; border:none;
                       border-radius:6px; cursor:pointer; font-size:.82em; }
        .analyze-btn:hover { background:#059669; }

        /* Modal */
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%;
                 background:rgba(0,0,0,.5); z-index:1000; align-items:center; justify-content:center; }
        .modal.active { display:flex; }
        .modal-content { background:white; padding:30px; border-radius:15px;
                         width:90%; max-width:860px; max-height:80vh; overflow-y:auto; position:relative; }
        .modal-close { position:absolute; top:15px; right:18px; font-size:26px; cursor:pointer; color:#999; }
        .modal-close:hover { color:#333; }
        .modal-content h3 { color:#333; margin:20px 0 10px; }

        .info-card { background:#f8f9fa; padding:16px; border-radius:10px; margin-bottom:10px; }
        .info-card .card-title { font-weight:700; color:#667eea; margin-bottom:10px; font-size:1.05em; }
        .type-tag { display:inline-block; padding:2px 10px; border-radius:12px; font-size:.75em; font-weight:600; margin-bottom:8px; }
        .tag-numeric     { background:#e3f2fd; color:#1976d2; }
        .tag-timestamp   { background:#fff8e1; color:#f57c00; }
        .tag-categorical { background:#f3e5f5; color:#7b1fa2; }
        .tag-boolean     { background:#e8f5e9; color:#2e7d32; }
        .tag-text        { background:#fce4ec; color:#c62828; }
        .tag-unknown     { background:#eeeeee; color:#616161; }

        .detail-row { display:flex; gap:6px; color:#555; font-size:.88em; margin:4px 0; }
        .detail-row strong { color:#333; min-width:140px; }
        .pill-row { display:flex; flex-wrap:wrap; gap:6px; margin-top:6px; }
        .pill { background:#eef2ff; color:#4338ca; padding:3px 10px; border-radius:20px; font-size:.8em; }
        .pill .count { color:#6366f1; font-weight:600; margin-left:4px; }
        .file-info-box { background:#eef2ff; border-radius:10px; padding:16px 20px; margin-bottom:6px; }
        .file-info-box .detail-row strong { min-width:120px; }
        .summary-row { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }

        .success-msg  { background:#d1fae5; color:#065f46; padding:12px; border-radius:8px; margin-bottom:15px; }
        .error-msg    { background:#ffebee; color:#c62828; padding:12px; border-radius:8px; margin-bottom:15px; }
        .warning-msg  { background:#fef3c7; color:#92400e; padding:12px; border-radius:8px; margin-bottom:15px; }

        .loading { text-align:center; padding:40px; color:#666; }
        .spinner { border:3px solid #f3f3f3; border-top:3px solid #667eea; border-radius:50%;
                   width:40px; height:40px; animation:spin 1s linear infinite; margin:0 auto 20px; }
        @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    </style>
</head>
<body>
<div class="container">

    <!-- Header -->
    <div class="header">
        <h1>üì° Wireless Research Lab</h1>
        <p>Data Platform for Channel &amp; Timestamp Analysis</p>
    </div>

    <!-- Stats -->
    <div class="stats">
        <div class="stat-card"><div class="value" id="totalFiles">-</div><div class="label">Total Files</div></div>
        <div class="stat-card"><div class="value" id="channelsFiles">-</div><div class="label">Channels</div></div>
        <div class="stat-card"><div class="value" id="timestampsFiles">-</div><div class="label">Timestamps</div></div>
        <div class="stat-card"><div class="value" id="csvFiles">-</div><div class="label">CSV Files</div></div>
        <div class="stat-card"><div class="value" id="uploadedFiles">-</div><div class="label">Uploaded</div></div>
        <div class="stat-card"><div class="value" id="totalSize">-</div><div class="label">Size (MB)</div></div>
    </div>

    <!-- ‚îÄ‚îÄ Jupyter Notebook Panel ‚îÄ‚îÄ -->
    <div class="jupyter-panel">
        <div class="jupyter-header">
            <h2>üìì Jupyter Notebook</h2>
            <span class="nb-status-badge badge-stopped" id="nbBadge">Stopped</span>
        </div>
        <div class="jupyter-body">
            <div class="nb-actions">
                <button class="btn btn-orange btn-sm" id="nbLaunchBtn" onclick="launchNotebook()">‚ñ∂ Launch Notebook</button>
                <button class="btn btn-danger btn-sm" id="nbStopBtn" onclick="stopNotebook()" style="display:none">‚ñ† Stop</button>
                <a href="#" class="open-notebook-link" id="nbOpenLink" target="_blank">üîó Open Notebook</a>
            </div>
            <p style="color:#9a3412; font-size:.84em; margin-bottom:14px;">
                Launches a Jupyter Notebook server rooted at your project folder ‚Äî <strong>uploads/</strong> and <strong>channels_release/</strong> are directly accessible inside it.
                You can also drag &amp; drop datasets below to add them instantly.
            </p>
            <!-- drag-drop zone for quick upload into notebook workspace -->
            <div class="nb-drop-zone" id="nbDropZone">
                <div class="drop-icon">üìÇ</div>
                <p><strong>Drag &amp; drop .mat or .csv files here</strong></p>
                <p>They land in <code>uploads/</code> and appear inside Jupyter immediately.</p>
            </div>
            <div class="nb-msg" id="nbMsg"></div>
        </div>
    </div>

    <!-- Upload -->
    <div class="upload-section">
        <h2>üì§ Upload New Dataset</h2>
        <div id="uploadMessage"></div>
        <div class="upload-area" id="uploadArea">
            <input type="file" id="fileInput" accept=".mat,.csv" hidden>
            <div style="font-size:3em;margin-bottom:10px">üìÅ</div>
            <p><strong>Drag &amp; drop a .mat or .csv file here</strong></p>
            <p style="color:#666;margin:10px 0">or</p>
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">Browse Files</button>
        </div>
        <div class="file-selected" id="fileSelected">
            <div>
                <strong>Selected:</strong> <span id="selectedFileName">-</span><br>
                <span style="color:#666;font-size:.9em">Size: <span id="selectedFileSize">-</span></span>
            </div>
            <div>
                <button class="btn btn-success" onclick="confirmUpload()">‚úì Upload File</button>
                <button class="btn btn-secondary" onclick="cancelUpload()">‚úó Cancel</button>
            </div>
        </div>
    </div>

    <!-- File list -->
    <div class="files-section">
        <h2>üìÅ Available Datasets</h2>
        <div id="fileList" class="file-list">
            <div class="loading"><div class="spinner"></div><p>Loading‚Ä¶</p></div>
        </div>
    </div>
</div>

<!-- Analysis Modal -->
<div class="modal" id="analysisModal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle">Analysis</h2>
        <div id="modalContent"></div>
    </div>
</div>

<script>
const API = 'http://localhost:5001';
let selectedFile = null;
let existingFiles = [];
let nbPollTimer = null;

// ‚îÄ‚îÄ‚îÄ STATS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadStats() {
    try {
        const { stats } = await (await fetch(`${API}/api/stats`)).json();
        document.getElementById('totalFiles').textContent     = stats.total_files;
        document.getElementById('channelsFiles').textContent  = stats.channels_files;
        document.getElementById('timestampsFiles').textContent= stats.timestamps_files;
        document.getElementById('csvFiles').textContent        = stats.csv_files||0;
        document.getElementById('uploadedFiles').textContent   = stats.uploaded_files||0;
        document.getElementById('totalSize').textContent       = stats.total_size_mb.toFixed(2);
    } catch(e){ console.error(e); }
}

// ‚îÄ‚îÄ‚îÄ FILE LIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadFiles() {
    try {
        const { files } = await (await fetch(`${API}/api/files`)).json();
        existingFiles = files.map(f=>f.name);
        const container = document.getElementById('fileList');
        container.innerHTML = '';
        files.forEach(file => {
            const typeClass = {channels:'type-channels',timestamps:'type-timestamps',csv:'type-csv'}[file.type]||'type-mat';
            const uploadedTag = file.source==='uploaded' ? ' ‚Ä¢ üì§ Uploaded' : '';
            const deleteBtn   = file.can_delete
                ? `<button class="btn btn-danger" onclick="deleteFile('${file.name}')">üóëÔ∏è</button>` : '';
            const div = document.createElement('div');
            div.className = 'file-item';
            div.innerHTML = `
                <div class="file-info">
                    <div class="file-name">${file.name}</div>
                    <div class="file-meta">${(file.size/1024).toFixed(2)} KB${uploadedTag}</div>
                </div>
                <div class="file-actions">
                    <span class="file-type ${typeClass}">${file.extension.toUpperCase()}</span>
                    <button class="analyze-btn" onclick="analyzeFile('${file.name}')">üîç Analyze</button>
                    ${deleteBtn}
                </div>`;
            container.appendChild(div);
        });
    } catch(e) {
        document.getElementById('fileList').innerHTML='<div class="error-msg">Failed to load files.</div>';
    }
}

// ‚îÄ‚îÄ‚îÄ UPLOAD (main section) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const uploadArea   = document.getElementById('uploadArea');
const fileInput    = document.getElementById('fileInput');
const uploadMsg    = document.getElementById('uploadMessage');
const fileSelected = document.getElementById('fileSelected');

uploadArea.addEventListener('dragover',  e=>{ e.preventDefault(); uploadArea.classList.add('drag-over'); });
uploadArea.addEventListener('dragleave', ()=> uploadArea.classList.remove('drag-over'));
uploadArea.addEventListener('drop', e=>{
    e.preventDefault(); uploadArea.classList.remove('drag-over');
    if(e.dataTransfer.files.length) handleFileSelect(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', e=>{ if(e.target.files.length) handleFileSelect(e.target.files[0]); });

function handleFileSelect(file) {
    uploadMsg.innerHTML='';
    if(!file.name.match(/\.(mat|csv)$/i)){
        uploadMsg.innerHTML='<div class="error-msg">‚ùå Only .mat and .csv files are allowed.</div>'; return;
    }
    if(existingFiles.includes(file.name)){
        uploadMsg.innerHTML=`<div class="warning-msg">‚ö†Ô∏è "${file.name}" already exists ‚Äî upload blocked.</div>`; return;
    }
    selectedFile = file;
    document.getElementById('selectedFileName').textContent = file.name;
    document.getElementById('selectedFileSize').textContent = (file.size/1024).toFixed(2)+' KB';
    fileSelected.classList.add('show');
}
function cancelUpload(){ selectedFile=null; fileSelected.classList.remove('show'); fileInput.value=''; uploadMsg.innerHTML=''; }

async function confirmUpload() {
    if(!selectedFile) return;
    const fd = new FormData(); fd.append('file', selectedFile);
    uploadMsg.innerHTML='<div class="loading"><div class="spinner"></div><p>Uploading‚Ä¶</p></div>';
    fileSelected.classList.remove('show');
    try {
        const data = await (await fetch(`${API}/api/upload`,{method:'POST',body:fd})).json();
        if(data.success){
            uploadMsg.innerHTML=`<div class="success-msg">‚úÖ ${data.filename} uploaded! (${(data.size/1024).toFixed(2)} KB)</div>`;
            selectedFile=null; fileInput.value='';
            loadStats(); loadFiles();
            setTimeout(()=> uploadMsg.innerHTML='', 5000);
        } else {
            uploadMsg.innerHTML=`<div class="error-msg">‚ùå ${data.error}</div>`;
        }
    } catch(e){ uploadMsg.innerHTML=`<div class="error-msg">‚ùå ${e.message}</div>`; }
}

// ‚îÄ‚îÄ‚îÄ DELETE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function deleteFile(name){
    if(!confirm(`Delete "${name}"?`)) return;
    try {
        const data = await (await fetch(`${API}/api/delete/${name}`,{method:'DELETE'})).json();
        if(data.success){
            uploadMsg.innerHTML=`<div class="success-msg">‚úÖ ${name} deleted.</div>`;
            loadStats(); loadFiles();
            setTimeout(()=> uploadMsg.innerHTML='', 3000);
        } else { uploadMsg.innerHTML=`<div class="error-msg">‚ùå ${data.error}</div>`; }
    } catch(e){ uploadMsg.innerHTML=`<div class="error-msg">‚ùå ${e.message}</div>`; }
}

// ‚îÄ‚îÄ‚îÄ JUPYTER NOTEBOOK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const nbBadge      = document.getElementById('nbBadge');
const nbLaunchBtn  = document.getElementById('nbLaunchBtn');
const nbStopBtn    = document.getElementById('nbStopBtn');
const nbOpenLink   = document.getElementById('nbOpenLink');
const nbMsg        = document.getElementById('nbMsg');
const nbDropZone   = document.getElementById('nbDropZone');

function setNbUI(status, url) {
    nbBadge.className = 'nb-status-badge';
    nbLaunchBtn.style.display = 'inline-block';
    nbStopBtn.style.display   = 'none';
    nbOpenLink.classList.remove('show');

    if(status === 'running') {
        nbBadge.classList.add('badge-running'); nbBadge.textContent = 'Running';
        nbLaunchBtn.style.display = 'none';
        nbStopBtn.style.display   = 'inline-block';
        if(url){ nbOpenLink.href = url; nbOpenLink.classList.add('show'); }
    } else if(status === 'starting') {
        nbBadge.classList.add('badge-starting'); nbBadge.textContent = 'Starting‚Ä¶';
        nbLaunchBtn.style.display = 'none';
        nbStopBtn.style.display   = 'inline-block';
    } else {
        nbBadge.classList.add('badge-stopped'); nbBadge.textContent = 'Stopped';
    }
}

async function launchNotebook() {
    nbMsg.innerHTML = '<span style="color:#9a3412">‚è≥ Launching Jupyter‚Ä¶ this may take a few seconds.</span>';
    nbLaunchBtn.disabled = true;
    try {
        const data = await (await fetch(`${API}/api/notebook/launch`,{method:'POST'})).json();
        if(!data.success){ nbMsg.innerHTML=`<div class="error-msg">‚ùå ${data.error}</div>`; nbLaunchBtn.disabled=false; return; }
        setNbUI(data.status, data.url);
        if(data.status === 'running'){
            nbMsg.innerHTML='<span style="color:#059669">‚úÖ Jupyter is ready. Click "Open Notebook" above.</span>';
        } else {
            nbMsg.innerHTML='<span style="color:#9a3412">‚è≥ Jupyter is starting‚Ä¶ waiting for it to be ready.</span>';
        }
        startNbPoll();
    } catch(e){ nbMsg.innerHTML=`<div class="error-msg">‚ùå ${e.message}</div>`; nbLaunchBtn.disabled=false; }
}

async function stopNotebook() {
    try {
        await fetch(`${API}/api/notebook/stop`,{method:'DELETE'});
        setNbUI('stopped', null);
        nbMsg.innerHTML='<span style="color:#666">Jupyter stopped.</span>';
        stopNbPoll();
    } catch(e){ nbMsg.innerHTML=`<div class="error-msg">‚ùå ${e.message}</div>`; }
}

function startNbPoll() {
    stopNbPoll();
    nbPollTimer = setInterval(async ()=>{
        try {
            const data = await (await fetch(`${API}/api/notebook/status`)).json();
            setNbUI(data.status, data.url);
            if(data.status === 'running' && data.url){
                nbMsg.innerHTML='<span style="color:#059669">‚úÖ Jupyter is ready. Click "Open Notebook" above.</span>';
                // slow down polling once running
                stopNbPoll();
                nbPollTimer = setInterval(async()=>{
                    const s = await (await fetch(`${API}/api/notebook/status`)).json();
                    setNbUI(s.status, s.url);
                    if(s.status==='stopped') stopNbPoll();
                }, 10000);
            }
            if(data.status === 'stopped'){ stopNbPoll(); nbLaunchBtn.disabled=false; }
        } catch(e){}
    }, 2000);
}
function stopNbPoll(){ if(nbPollTimer){ clearInterval(nbPollTimer); nbPollTimer=null; } }

// ‚îÄ‚îÄ‚îÄ Jupyter panel drag-and-drop (uploads to uploads/) ‚îÄ‚îÄ
nbDropZone.addEventListener('dragover',  e=>{ e.preventDefault(); nbDropZone.classList.add('drag-over'); });
nbDropZone.addEventListener('dragleave', ()=> nbDropZone.classList.remove('drag-over'));
nbDropZone.addEventListener('drop', async e=>{
    e.preventDefault(); nbDropZone.classList.remove('drag-over');
    const files = Array.from(e.dataTransfer.files).filter(f=> f.name.match(/\.(mat|csv)$/i));
    if(!files.length){ nbMsg.innerHTML='<span style="color:#c62828">Only .mat and .csv files are supported.</span>'; return; }
    nbMsg.innerHTML='<span style="color:#9a3412">‚è≥ Uploading‚Ä¶</span>';
    let ok=0, errors=[];
    for(const file of files){
        const fd = new FormData(); fd.append('file', file);
        try {
            const data = await (await fetch(`${API}/api/upload`,{method:'POST',body:fd})).json();
            if(data.success) ok++;
            else errors.push(`${file.name}: ${data.error}`);
        } catch(err){ errors.push(`${file.name}: network error`); }
    }
    loadStats(); loadFiles();
    if(ok && !errors.length){
        nbMsg.innerHTML=`<span style="color:#059669">‚úÖ ${ok} file${ok>1?'s':''} uploaded ‚Äî available in Jupyter now.</span>`;
    } else if(ok){
        nbMsg.innerHTML=`<span style="color:#059669">‚úÖ ${ok} uploaded.</span> <span style="color:#c62828">${errors.join('; ')}</span>`;
    } else {
        nbMsg.innerHTML=`<span style="color:#c62828">‚ùå ${errors.join('; ')}</span>`;
    }
});

// ‚îÄ‚îÄ‚îÄ ANALYZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function analyzeFile(filename) {
    document.getElementById('modalTitle').textContent = filename;
    document.getElementById('analysisModal').classList.add('active');
    document.getElementById('modalContent').innerHTML = '<div class="loading"><div class="spinner"></div><p>Analyzing‚Ä¶</p></div>';
    try {
        const { success, metadata, error } = await (await fetch(`${API}/api/analyze/${filename}`)).json();
        if(!success) throw new Error(error);
        document.getElementById('modalContent').innerHTML =
            metadata.file_type==='CSV' ? renderCSV(metadata) : renderMAT(metadata);
    } catch(e){ document.getElementById('modalContent').innerHTML=`<div class="error-msg">‚ùå ${e.message}</div>`; }
}

function renderCSV(m) {
    let html=`<div class="file-info-box">
        <div class="detail-row"><strong>Filename</strong>${m.filename}</div>
        <div class="detail-row"><strong>Size</strong>${(m.file_size/1024).toFixed(2)} KB</div>
        <div class="detail-row"><strong>Rows</strong>${m.num_rows.toLocaleString()}</div>
        <div class="detail-row"><strong>Columns</strong>${m.num_columns}</div>
        <div class="detail-row"><strong>Null cells</strong>${m.total_null_cells} ${m.has_nulls?'‚ö†Ô∏è':'‚úÖ none'}</div>
        <div class="detail-row"><strong>Column types</strong><div class="summary-row">`;
    for(const[type,count] of Object.entries(m.type_summary))
        html+=`<span class="type-tag tag-${type}">${type} (${count})</span>`;
    html+='</div></div></div><h3>üìä Columns</h3>';

    for(const[colName,col] of Object.entries(m.columns)){
        html+=`<div class="info-card">
            <div class="card-title">${colName}</div>
            <span class="type-tag tag-${col.detected_type}">${col.detected_type}</span>
            <div class="detail-row"><strong>Raw dtype</strong>${col.dtype}</div>
            <div class="detail-row"><strong>Total values</strong>${col.total_values.toLocaleString()}</div>
            <div class="detail-row"><strong>Non-null</strong>${col.non_null_count.toLocaleString()}</div>
            <div class="detail-row"><strong>Null count</strong>${col.null_count} ${col.null_count>0?'‚ö†Ô∏è':'‚úÖ'}</div>
            <div class="detail-row"><strong>Unique values</strong>${col.unique_values.toLocaleString()}</div>`;
        if(col.detected_type==='numeric') html+=`
            <div class="detail-row"><strong>Min</strong>${col.min}</div>
            <div class="detail-row"><strong>Max</strong>${col.max}</div>
            <div class="detail-row"><strong>Mean</strong>${col.mean}</div>
            <div class="detail-row"><strong>Median</strong>${col.median}</div>
            <div class="detail-row"><strong>Std Dev</strong>${col.std}</div>
            <div class="detail-row"><strong>25th %ile</strong>${col.percentile_25}</div>
            <div class="detail-row"><strong>75th %ile</strong>${col.percentile_75}</div>`;
        if(col.detected_type==='timestamp') html+=`
            <div class="detail-row"><strong>Earliest</strong>${col.min}</div>
            <div class="detail-row"><strong>Latest</strong>${col.max}</div>
            ${col.time_range_seconds!=null?`<div class="detail-row"><strong>Range</strong>${col.time_range_seconds.toLocaleString()} seconds</div>`:''}`;
        if(col.detected_type==='categorical'&&col.top_values){
            html+=`<div class="detail-row"><strong>Top values</strong></div><div class="pill-row">`;
            col.top_values.forEach(tv=> html+=`<span class="pill">${tv.value}<span class="count">√ó${tv.count}</span></span>`);
            html+='</div>';
        }
        if(col.detected_type==='boolean') html+=`
            <div class="detail-row"><strong>True</strong>${col.true_count}</div>
            <div class="detail-row"><strong>False</strong>${col.false_count}</div>`;
        if(col.detected_type==='text') html+=`
            <div class="detail-row"><strong>Avg length</strong>${col.avg_length} chars</div>
            <div class="detail-row"><strong>Min length</strong>${col.min_length} chars</div>
            <div class="detail-row"><strong>Max length</strong>${col.max_length} chars</div>`;
        if(col.sample_values&&col.sample_values.length){
            html+=`<div class="detail-row"><strong>Samples</strong></div><div class="pill-row">`;
            col.sample_values.forEach(v=> html+=`<span class="pill">${v}</span>`);
            html+='</div>';
        }
        html+='</div>';
    }
    return html;
}

function renderMAT(m) {
    let html=`<div class="file-info-box">
        <div class="detail-row"><strong>Filename</strong>${m.filename}</div>
        <div class="detail-row"><strong>Size</strong>${(m.file_size/1024).toFixed(2)} KB</div>
        <div class="detail-row"><strong>Variables</strong>${Object.keys(m.variables).length}</div>
    </div><h3>üìä Variables</h3>`;
    for(const[name,v] of Object.entries(m.variables)){
        html+=`<div class="info-card">
            <div class="card-title">${name}</div>
            <div class="detail-row"><strong>Shape</strong>${v.shape.join(' √ó ')}</div>
            <div class="detail-row"><strong>Type</strong>${v.dtype}</div>
            <div class="detail-row"><strong>Elements</strong>${v.size.toLocaleString()}</div>
            <div class="detail-row"><strong>Dimensions</strong>${v.ndim}D</div>`;
        if(v.min!==undefined) html+=`
            <div class="detail-row"><strong>Min</strong>${v.min}</div>
            <div class="detail-row"><strong>Max</strong>${v.max}</div>
            <div class="detail-row"><strong>Mean</strong>${v.mean}</div>`;
        html+='</div>';
    }
    return html;
}

function closeModal(){ document.getElementById('analysisModal').classList.remove('active'); }

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', ()=>{
    loadStats(); loadFiles();
    // check notebook status on page load
    fetch(`${API}/api/notebook/status`).then(r=>r.json()).then(d=>{
        setNbUI(d.status, d.url);
        if(d.status==='running'||d.status==='starting') startNbPoll();
    }).catch(()=>{});
    setInterval(()=>{ loadStats(); loadFiles(); }, 30000);
});
</script>
</body>
</html>